<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>Temperature charts</title>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

        <style type="text/css">

            path { 
                stroke: teal;
                stroke-width: 2;
                fill: none;
            }

            svg {
                display: block;
                margin: auto;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: black;
                shape-rendering: crispEdges;
            }

            .axis text {
                font-family: sans-serif;
                font-size: 12px;
            }

            .axisLabel {
                font: Garamond;
                font-size: 15px;
            }

            #currentTemp {
                font: Garamond;
                font-size: 20px;
                margin: auto;
                text-align: center;
                padding: 20px;
                width: 500px;
            }

        </style>

    </head>

    <body>
        <script type="text/javascript">

        // Define mean function
        function mean(array)
            {
             var sum = 0, i;
             for (i = 0; i < array.length; i++)
             {
              sum += array[i];
             }
              return array.length ? sum / array.length : 0;
            }

            var dataset;

            var margin = {top: 20, right: 20, bottom: 60, left: 60};
            var w = 800 - margin.left - margin.right;
            var h = 400 - margin.top - margin.bottom;

            var yScale, xScale;
            var xAxis, yAxis;

            var CHANGE_THRESH = 0.25; // Degrees per hour

            // Make the current temperature block
            var currentTemp = d3.select("body")
                .append("div")
                .attr("id","currentTemp")

            // Make the svg element where the graph will appear
            var svg = d3.select("body")
                .append("svg")
                .attr("width",w + margin.left + margin.right)
                .attr("height",h + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");



            d3.csv("data24.csv", 
                function(error, data) {
                    if (error){
                        // Log the error
                        console.log(error);
                    } else {

                        data.forEach(function(d) {
                            d.Time = new Date(d.Time);
                        });

                        dataset = data;
                        setCurrentTemp();
                        generateScales();
                        generateLine();
                        //generateCirlces();
                        generateAxes();

                    }
                }
            );

            function setCurrentTemp(){
                var tempFormat = d3.format(".1f");
                currentTemp.text("Current temperature is: " 
                    + tempFormat(dataset[dataset.length - 1].Temperature)
                    + "C");

                // Describe the trend
                var temps = dataset.map(function(d) {return Number(d.Temperature);});

                // Use only the last 30 readings
                var past = mean(temps.slice(-30,-15))
                var now = mean(temps.slice(-15))
                if (Math.abs(now - past) > CHANGE_THRESH/2){
                    if (now-past > 0) {
                        currentTemp.append("p")
                        .text(" and getting warmer.")
                    } else {
                        currentTemp.append("p")
                        .text(" and getting cooler.")
                    }
                } else {
                    currentTemp.append("p")
                        .text(" and staying about the same.")
                }
            }

            function generateScales(){

                yScale = d3.scale.linear()
                    .domain([d3.min(dataset, function(d) { return d.Temperature; }) - 1,
                                d3.max(dataset, function(d) { return d.Temperature; }) + 1])
                    .range([h, 0])
                    .nice();

                xScale = d3.time.scale()
                    .domain(d3.extent(dataset, function(d) { return d.Time; }))
                    .range([0, w]);

            }

            function generateLine(){

                // Define the line
                var valueline = d3.svg.line()
                    .x(function(d) { return xScale(d.Time); })
                    .y(function(d) { return yScale(d.Temperature); });

                svg.append("path")
                    .attr("class", "line")
                    .attr("d", valueline(dataset));

            }

            function generateCirlces(){

                var markers = svg.append("g");

                markers.selectAll("cirlce")
                    .data(dataset)
                    .enter()
                    .append("circle")
                    .attr("r",2)
                    .attr("stroke","teal")
                    .attr("fill","white")
                    .attr("cx",function(d){
                        return xScale(d.Time);
                    })
                    .attr("cy",function(d){
                        return yScale(d.Temperature);
                    })
            }

            function generateAxes(){
                xAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient("bottom");

                svg.append("g")
                    .attr("transform", "translate(0," + h + ")")
                    .attr("class", "axis")
                    .call(xAxis);

                yAxis = d3.svg.axis()
                  .scale(yScale)
                  .orient("left");

                svg.append("g")
                    .attr("transform", "translate(" + 0 + ",0)")
                    .attr("class", "axis")
                    .call(yAxis);

                // Add axis labels
                svg.append("text")
                    .attr("class", "axisLabel")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - h/2 )
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Temperature (C)");

                svg.append("text")
                    .attr("class", "axisLabel")
                    .attr("x", w/2 )
                    .attr("y",h + margin.bottom )
                    .attr("dy", "-1em")
                    .style("text-anchor", "middle")
                    .text("Time");
            }

            function generateBars(){

                svg.selectAll("rect")
                    .data(dataset)
                    .enter()
                    .append("rect")
                    .attr("x",0)
                    .attr("y",0)
                    .attr("height",h)
                    .attr("width",w / dataset.length - barPadding)
                    .attr("fill", "teal")
                    .attr("y", function(d){
                        return h - yScale(d.Temperature);
                    })
                    .attr("height", function(d,i){
                        console.log(d.Temperature);
                        return yScale(d.Temperature);
                    })
                    .attr("x", function(d,i) {
                        return i*(w/dataset.length);
                    })
                    ;

            };

        </script>
    </body>
</html>